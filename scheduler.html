{% extends "base.html" %}

{% block title %}Scheduler - Dom Creator Dashboard{% endblock %}

{% block extra_css %}
<style>
    .scheduler-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .scheduler-section {
            grid-template-columns: 1fr;
        }
    }

    .form-section, .posts-section {
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s, transform 0.2s;
        touch-action: manipulation;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .posts-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .post-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border-left: 5px solid #ccc;
        margin-bottom: 1rem;
        background-color: #f9f9f9;
        border-radius: 4px;
        transition: box-shadow 0.3s;
    }

    .post-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .post-item.tiktok {
        border-left-color: #000000;
    }

    .post-item.youtube {
        border-left-color: #FF0000;
    }

    .post-item.instagram {
        border-left-color: #E1306C;
    }

    .post-item.facebook {
        border-left-color: #1877F2;
    }

    .post-item.linkedin {
        border-left-color: #0A66C2;
    }

    .post-item.threads {
        border-left-color: #333333;
    }

    .post-platform-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
        white-space: nowrap;
        text-transform: uppercase;
        min-width: 90px;
        text-align: center;
    }

    .post-platform-badge.tiktok {
        background-color: #000000;
    }

    .post-platform-badge.youtube {
        background-color: #FF0000;
    }

    .post-platform-badge.instagram {
        background-color: #E1306C;
    }

    .post-platform-badge.facebook {
        background-color: #1877F2;
    }

    .post-platform-badge.linkedin {
        background-color: #0A66C2;
    }

    .post-platform-badge.threads {
        background-color: #333333;
    }

    .post-content {
        flex: 1;
    }

    .post-caption {
        margin: 0.5rem 0;
        color: #333;
        word-wrap: break-word;
    }

    .post-datetime {
        font-size: 0.9rem;
        color: #666;
        margin: 0.5rem 0;
    }

    .post-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .post-actions button {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }

    .view-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .view-toggle button {
        padding: 0.5rem 1rem;
        border: 2px solid #007bff;
        background: white;
        color: #007bff;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
    }

    .view-toggle button.active {
        background: #007bff;
        color: white;
    }

    .calendar-view {
        display: none;
    }

    .calendar-view.active {
        display: block;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 0.5rem;
        font-size: 0.85rem;
        background: #f9f9f9;
        position: relative;
        overflow: hidden;
    }

    .calendar-day.has-posts {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .calendar-day-number {
        font-weight: 600;
        color: #333;
    }

    .success-message, .error-message {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        display: none;
    }

    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .success-message.show {
        display: block;
    }

    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .error-message.show {
        display: block;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="scheduler-container">
    <h2>Post Scheduler</h2>
    
    <div id="successMessage" class="success-message">
        <strong>Success!</strong> <span id="successText"></span>
    </div>
    <div id="errorMessage" class="error-message">
        <strong>Error!</strong> <span id="errorText"></span>
    </div>

    <div class="scheduler-section">
        <!-- Form Section -->
        <div class="form-section">
            <h3>Create New Post</h3>
            <form id="postForm">
                <div class="form-group">
                    <label for="platform">Platform *</label>
                    <select id="platform" name="platform" required>
                        <option value="">Select a platform</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube (Shorts)</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="threads">Threads</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="scheduledDatetime">Schedule Date & Time *</label>
                    <input type="datetime-local" id="scheduledDatetime" name="scheduledDatetime" required>
                </div>

                <div class="form-group">
                    <label for="caption">Caption / Description *</label>
                    <textarea id="caption" name="caption" placeholder="Write your post caption here..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="linkOrAssetNote">Link or Asset Note</label>
                    <input type="text" id="linkOrAssetNote" name="linkOrAssetNote" placeholder="e.g., YouTube link, asset file name, etc.">
                </div>

                <button type="submit" class="btn-primary">Schedule Post</button>
            </form>
        </div>

        <!-- Posts Section -->
        <div class="posts-section">
            <h3>Scheduled Posts</h3>
            
            <div class="view-toggle">
                <button class="view-btn active" data-view="list">ðŸ“‹ List</button>
                <button class="view-btn" data-view="calendar">ðŸ“… Calendar</button>
            </div>

            <!-- List View -->
            <div id="listView" class="list-view active">
                <ul id="postsList" class="posts-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <p>No scheduled posts yet. Create one to get started!</p>
                    </div>
                </ul>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="calendar-view">
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const PLATFORM_COLORS = {
    'tiktok': '#000000',
    'youtube': '#FF0000',
    'instagram': '#E1306C',
    'facebook': '#1877F2',
    'linkedin': '#0A66C2',
    'threads': '#333333'
};

// DOM Elements
const postForm = document.getElementById('postForm');
const postsList = document.getElementById('postsList');
const listViewBtn = document.querySelector('.view-btn[data-view="list"]');
const calendarViewBtn = document.querySelector('.view-btn[data-view="calendar"]');
const listView = document.getElementById('listView');
const calendarView = document.getElementById('calendarView');
const successMsg = document.getElementById('successMessage');
const errorMsg = document.getElementById('errorMessage');
const successText = document.getElementById('successText');
const errorText = document.getElementById('errorText');

// Load posts on page load
document.addEventListener('DOMContentLoaded', loadPosts);

// Form submission
postForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(postForm);
    const postData = {
        platform: formData.get('platform'),
        scheduled_datetime: formData.get('scheduledDatetime'),
        caption: formData.get('caption'),
        link_or_asset_note: formData.get('linkOrAssetNote')
    };

    try {
        const response = await fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create post');
        }

        postForm.reset();
        showSuccess('Post scheduled successfully!');
        loadPosts();
    } catch (error) {
        showError(error.message);
    }
});

// View toggle
listViewBtn.addEventListener('click', () => {
    listView.classList.add('active');
    calendarView.classList.remove('active');
    listViewBtn.classList.add('active');
    calendarViewBtn.classList.remove('active');
});

calendarViewBtn.addEventListener('click', () => {
    calendarView.classList.add('active');
    listView.classList.remove('active');
    calendarViewBtn.classList.add('active');
    listViewBtn.classList.remove('active');
});

// Load all posts
async function loadPosts() {
    try {
        const response = await fetch('/api/posts');
        if (!response.ok) throw new Error('Failed to load posts');
        const posts = await response.json();
        renderPostsList(posts);
        renderCalendar(posts);
    } catch (error) {
        showError('Failed to load posts');
    }
}

// Render list view
function renderPostsList(posts) {
    if (posts.length === 0) {
        postsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“­</div>
                <p>No scheduled posts yet. Create one to get started!</p>
            </div>
        `;
        return;
    }

    postsList.innerHTML = posts.map(post => {
        const dateTime = new Date(post.scheduled_datetime);
        const formattedDate = dateTime.toLocaleString();
        
        return `
            <li class="post-item ${post.platform}">
                <span class="post-platform-badge ${post.platform}">${post.platform.toUpperCase()}</span>
                <div class="post-content">
                    <p class="post-caption">${escapeHtml(post.caption)}</p>
                    <p class="post-datetime">ðŸ“… ${formattedDate}</p>
                    ${post.link_or_asset_note ? `<p class="post-link">ðŸ”— ${escapeHtml(post.link_or_asset_note)}</p>` : ''}
                </div>
                <div class="post-actions">
                    <button class="btn-secondary" onclick="editPost(${post.id})">Edit</button>
                    <button class="btn-danger" onclick="deletePost(${post.id})">Delete</button>
                </div>
            </li>
        `;
    }).join('');
}

// Render calendar view
function renderCalendar(posts) {
    const calendarGrid = document.getElementById('calendarGrid');
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Get first day of month and number of days
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    calendarGrid.innerHTML = '';

    // Add day headers (optional)
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        header.style.fontWeight = 'bold';
        header.style.textAlign = 'center';
        header.style.paddingBottom = '0.5rem';
    });

    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.backgroundColor = '#f0f0f0';
        calendarGrid.appendChild(emptyDay);
    }

    // Add days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        
        const dateObj = new Date(currentYear, currentMonth, day);
        const postsForDay = posts.filter(post => {
            const postDate = new Date(post.scheduled_datetime);
            return postDate.toDateString() === dateObj.toDateString();
        });

        if (postsForDay.length > 0) {
            dayCell.classList.add('has-posts');
            const colors = postsForDay.map(p => PLATFORM_COLORS[p.platform]);
            const colorString = colors.join(', ');
            dayCell.style.borderLeft = `4px solid ${PLATFORM_COLORS[postsForDay[0].platform]}`;
        }

        dayCell.innerHTML = `
            <div class="calendar-day-number">${day}</div>
            ${postsForDay.length > 0 ? `<small>${postsForDay.length} post${postsForDay.length > 1 ? 's' : ''}</small>` : ''}
        `;
        
        calendarGrid.appendChild(dayCell);
    }
}

// Delete post
async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) return;

    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete post');
        
        showSuccess('Post deleted successfully!');
        loadPosts();
    } catch (error) {
        showError('Failed to delete post');
    }
}

// Edit post (for now, just allow deletion and recreation)
function editPost(postId) {
    alert('Edit feature coming soon! For now, delete and recreate the post.');
}

// Utility functions
function showSuccess(message) {
    successText.textContent = message;
    successMsg.classList.add('show');
    setTimeout(() => successMsg.classList.remove('show'), 4000);
}

function showError(message) {
    errorText.textContent = message;
    errorMsg.classList.add('show');
    setTimeout(() => errorMsg.classList.remove('show'), 4000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
